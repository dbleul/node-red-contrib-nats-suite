<script type="text/javascript">
  RED.nodes.registerType('nats-suite-kv-get', {
    category: 'NATS Suite',
    color: '#2FAF9C',
    defaults: {
      name: {
        value: '',
      },
      server: {
        value: '',
        type: 'nats-suite-server',
        required: true
      },
      bucket: {
        value: ''
      },
      bucketConfig: {
        value: '',
        type: 'nats-suite-kv-bucket',
        required: false
      },
      description: {
        value: ''
      },
      history: {
        value: 10
      },
      maxAge: {
        value: 0
      },
      maxBytes: {
        value: 0
      },
      maxValueSize: {
        value: 0
      },
      compression: {
        value: false
      },
      replicas: {
        value: 1
      },
      storage: {
        value: 'file'
      },
      mode: {
        value: 'get',
        required: true
      },
      key: {
        value: ''
      },
      keyFrom: {
        value: 'config'
      },
      watchPattern: {
        value: ''
      },
      includeHistory: {
        value: false
      },
      ignoreDeletes: {
        value: true
      },
      parseJSON: {
        value: true
      },
      debug: {
        value: false
      }
    },
    inputs: 1,
    outputs: 1,
    icon: 'nats-icon-white.png',
    align: 'left',
    label: function () {
      return this.name || `kv get (${this.bucket || 'bucket'})`;
    },
    paletteLabel: 'nats kv get',
    oneditprepare: function() {
      // Show/hide based on mode
      $('#node-input-mode').on('change', function() {
        const mode = $(this).val();
        
        if (mode === 'get') {
          $('#get-config').show();
          $('#watch-config').hide();
        } else if (mode === 'watch') {
          $('#get-config').hide();
          $('#watch-config').show();
        } else if (mode === 'keys') {
          $('#get-config').hide();
          $('#watch-config').hide();
        }
      });
      
      // Show/hide key input based on keyFrom
      $('#node-input-keyFrom').on('change', function() {
        if ($(this).val() === 'config') {
          $('#key-config-row').show();
        } else {
          $('#key-config-row').hide();
        }
      });
      
      // Trigger initial state
      $('#node-input-mode').trigger('change');
      $('#node-input-keyFrom').trigger('change');
      
      // Show/hide bucket direct config based on bucketConfig
      $('#node-input-bucketConfig').on('change', function() {
        if ($(this).val()) {
          $('#bucket-direct-config').hide();
          $('#bucket-settings').hide();
        } else {
          $('#bucket-direct-config').show();
          $('#bucket-settings').show();
        }
      });
      $('#node-input-bucketConfig').trigger('change');
    }
  });
</script>

<script type="text/x-red" data-template-name="nats-suite-kv-get">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="KV Get">
  </div>
  
  <div class="form-row">
      <label for="node-input-server"><i class="fa fa-server"></i> NATS Server</label>
      <input type="text" id="node-input-server">
  </div>
  
  <div class="form-row">
      <label for="node-input-bucketConfig"><i class="fa fa-database"></i> Bucket Config (optional)</label>
      <input type="text" id="node-input-bucketConfig">
      <div style="margin-top: 5px; color: #999; font-size: 11px; margin-left: 110px;">
          Optional: Use bucket config node OR configure bucket directly below
      </div>
  </div>
  
  <div class="form-row" id="bucket-direct-config">
      <label for="node-input-bucket"><i class="fa fa-database"></i> Bucket Name</label>
      <input type="text" id="node-input-bucket" placeholder="my-bucket">
  </div>
  
  <div class="form-row" id="bucket-settings" style="display: none;">
      <label for="node-input-description"><i class="fa fa-info-circle"></i> Description</label>
      <input type="text" id="node-input-description" placeholder="Optional description">
      
      <label for="node-input-history"><i class="fa fa-history"></i> History</label>
      <input type="number" id="node-input-history" placeholder="10" min="1" max="100" style="width: 100px;">
      
      <label for="node-input-maxAge"><i class="fa fa-clock-o"></i> TTL (seconds)</label>
      <input type="number" id="node-input-maxAge" placeholder="0" min="0" style="width: 100px;">
      
      <label for="node-input-maxBytes"><i class="fa fa-hdd-o"></i> Max Bytes</label>
      <input type="number" id="node-input-maxBytes" placeholder="0" min="0" style="width: 150px;">
      
      <label for="node-input-maxValueSize"><i class="fa fa-file-o"></i> Max Value Size</label>
      <input type="number" id="node-input-maxValueSize" placeholder="0" min="0" style="width: 150px;">
      
      <label for="node-input-compression"><i class="fa fa-compress"></i> Compression</label>
      <input type="checkbox" id="node-input-compression" style="vertical-align: middle;">
      
      <label for="node-input-replicas"><i class="fa fa-copy"></i> Replicas</label>
      <input type="number" id="node-input-replicas" placeholder="1" min="1" max="5" style="width: 100px;">
      
      <label for="node-input-storage"><i class="fa fa-database"></i> Storage</label>
      <select id="node-input-storage" style="width:70%">
          <option value="file">File</option>
          <option value="memory">Memory</option>
      </select>
  </div>
  
  <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
  
  <div class="form-row">
      <label for="node-input-mode"><i class="fa fa-cog"></i> Operation Mode</label>
      <select id="node-input-mode" style="width:70%">
          <option value="get">Get Value</option>
          <option value="watch">Watch Key(s)</option>
          <option value="keys">List All Keys</option>
      </select>
  </div>
  
  <div id="get-config">
      <div class="form-row">
          <label for="node-input-keyFrom"><i class="fa fa-arrow-right"></i> Key From</label>
          <select id="node-input-keyFrom" style="width:70%">
              <option value="config">Configuration</option>
              <option value="msg">msg.key</option>
              <option value="payload">msg.payload</option>
          </select>
      </div>
      
      <div class="form-row" id="key-config-row">
          <label for="node-input-key"><i class="fa fa-key"></i> Key</label>
          <input type="text" id="node-input-key" placeholder="config.production.speed" style="width: 70%;">
          <div style="margin-top: 5px; color: #999; font-size: 11px; margin-left: 110px;">
              Key to retrieve from KV store
          </div>
      </div>
      
      <div class="form-row">
          <label for="node-input-includeHistory"><i class="fa fa-history"></i> Include History</label>
          <input type="checkbox" id="node-input-includeHistory" style="vertical-align: middle;">
          <span style="margin-left: 10px; color: #999;">Return revision history</span>
      </div>
  </div>
  
  <div id="watch-config" style="display: none;">
      <div class="form-row">
          <label for="node-input-watchPattern"><i class="fa fa-eye"></i> Watch Pattern</label>
          <input type="text" id="node-input-watchPattern" placeholder="config.* or config.production.speed" style="width: 70%;">
          <div style="margin-top: 5px; color: #999; font-size: 11px; margin-left: 110px;">
              Key pattern to watch (use * for wildcard, leave empty for all keys)
          </div>
      </div>
      
      <div class="form-row">
          <label for="node-input-ignoreDeletes"><i class="fa fa-trash"></i> Ignore Deletes</label>
          <input type="checkbox" id="node-input-ignoreDeletes" style="vertical-align: middle;">
          <span style="margin-left: 10px; color: #999;">Don't emit messages for deleted keys</span>
      </div>
  </div>
  
  <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
  
  <div class="form-row">
      <label for="node-input-parseJSON"><i class="fa fa-code"></i> Auto-Parse JSON</label>
      <input type="checkbox" id="node-input-parseJSON" style="vertical-align: middle;">
      <span style="margin-left: 10px; color: #999;">Automatically parse JSON values</span>
  </div>
  
  <div class="form-row">
      <label for="node-input-debug"><i class="fa fa-bug"></i> Debug Logging</label>
      <input type="checkbox" id="node-input-debug" style="vertical-align: middle;">
      <span style="margin-left: 10px; color: #999;">Enable detailed logging for this node</span>
  </div>
</script>

<script type="text/x-red" data-help-name="nats-suite-kv-get">
  <p>Get values from NATS Key-Value store or watch for changes.</p>

  <h3>Operation Modes</h3>
  
  <h4>Get Value</h4>
  <p>Retrieve a single value from the KV store.</p>
  <pre><code>Input:  msg.key = "config.production.speed"
Output: msg.payload = 100
        msg.revision = 5
        msg.operation = "GET"</code></pre>
  
  <h4>Watch Key(s)</h4>
  <p>Subscribe to key changes. Emits a message whenever a key is created, updated, or deleted.</p>
  <pre><code>Watch: "config.*"
Output (on change):
  msg.payload = <new value>
  msg.key = "config.production.speed"
  msg.operation = "PUT" | "DEL"
  msg.revision = 6</code></pre>
  
  <h4>List All Keys</h4>
  <p>Get a list of all keys in the bucket.</p>
  <pre><code>Output: msg.payload = ["key1", "key2", "key3"]</code></pre>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Bucket Name</dt>
    <dd>Name of the NATS KV bucket. Will be created automatically if it doesn't exist.</dd>
    
    <dt>Key From</dt>
    <dd>Where to read the key name from:
      <ul>
        <li><strong>Configuration:</strong> Use the configured key</li>
        <li><strong>msg.key:</strong> Read from msg.key property</li>
        <li><strong>msg.payload:</strong> Use msg.payload as key</li>
      </ul>
    </dd>
    
    <dt>Watch Pattern</dt>
    <dd>Pattern for watching keys. Use <code>*</code> for wildcard matching (e.g., <code>config.*</code>).</dd>
    
    <dt>Include History</dt>
    <dd>For GET mode: Include revision history in msg._history array.</dd>
    
    <dt>Ignore Deletes</dt>
    <dd>For WATCH mode: Don't emit messages when keys are deleted.</dd>
    
    <dt>Auto-Parse JSON</dt>
    <dd>Automatically parse JSON strings to objects.</dd>
  </dl>

  <h3>Output Message</h3>
  <dl class="message-properties">
    <dt>payload</dt>
    <dd>The value retrieved from the KV store (or array of keys for LIST mode).</dd>
    
    <dt>key</dt>
    <dd>The key name.</dd>
    
    <dt>operation</dt>
    <dd>The operation type: "GET", "PUT", "DEL", or "LIST".</dd>
    
    <dt>revision</dt>
    <dd>The revision number of the value.</dd>
    
    <dt>created</dt>
    <dd>Timestamp when the key was created (ISO 8601).</dd>
    
    <dt>bucket</dt>
    <dd>The bucket name.</dd>
  </dl>

  <h3>Use Cases</h3>
  <ul>
    <li><strong>Configuration Storage:</strong> Store and retrieve application config</li>
    <li><strong>Feature Flags:</strong> Dynamic feature toggles</li>
    <li><strong>Session State:</strong> Shared state across flows</li>
    <li><strong>Cache:</strong> Distributed caching</li>
    <li><strong>Real-time Sync:</strong> Watch for config changes and react</li>
  </ul>
</script>

