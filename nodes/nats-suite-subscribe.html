<script type="text/javascript">
  RED.nodes.registerType('nats-suite-subscribe', {
    category: 'NATS Suite',
    color: '#2FAF9C',
    defaults: {
      name: { value: '' },
      server: { value: '', type: 'nats-suite-server' },
      debug: { value: false },
      dataformat: { value: 'auto', required: true },
      datapointid: { value: '', required: false },
      topicfield: { value: 'subject' },
      subscriptionMode: { value: 'static' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'nats-icon-white.png',
    align: 'left',
    label: function () {
      return this.name || 'nats subscribe';
    },
    paletteLabel: 'nats subscribe',
    oneditprepare: function() {
      // Collapsible sections
      $('.nats-section-header').on('click', function() {
        const $header = $(this);
        const $content = $header.next('.nats-section-content');
        const $icon = $header.find('.nats-section-toggle');
        $content.slideToggle(200);
        $icon.toggleClass('fa-chevron-down fa-chevron-right');
        $header.toggleClass('collapsed');
      });
      
      // Subscription mode handler
      $('#node-input-subscriptionMode').on('change', function() {
        if ($(this).val() === 'static') {
          $('#nats-subject-row').slideDown(200);
        } else {
          $('#nats-subject-row').slideUp(200);
        }
      });
      
      // Trigger initial state
      $('#node-input-subscriptionMode').trigger('change');
    },
    oneditsave: function() {
      const mode = $('#node-input-subscriptionMode').val();
      if (mode === 'static') {
        const subject = $('#node-input-datapointid').val();
        if (!subject || subject.trim().length === 0) {
          RED.notify.error('NATS Subject is required in Static mode');
          return false;
        }
      }
      return true;
    }
  });
</script>

<script type="text/x-red" data-template-name="nats-suite-subscribe">
  <style>
    .nats-subscribe-config {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .nats-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .nats-section-header {
      background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e1e4e8;
      transition: background 0.2s ease;
      user-select: none;
    }
    .nats-section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    .nats-section-header.collapsed { border-bottom: none; }
    .nats-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 13px;
      color: #2c3e50;
    }
    .nats-section-title i {
      width: 18px;
      text-align: center;
      color: #2FAF9C;
      font-size: 14px;
    }
    .nats-section-toggle {
      color: #6c757d;
      font-size: 11px;
      transition: transform 0.2s ease;
    }
    .nats-section-content { padding: 14px; }
    .nats-form-row { margin-bottom: 12px; }
    .nats-form-row:last-child { margin-bottom: 0; }
    .nats-form-row label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #495057;
      margin-bottom: 5px;
    }
    .nats-form-row label i {
      margin-right: 6px;
      color: #2FAF9C;
      width: 14px;
      text-align: center;
    }
    .nats-form-row input[type="text"],
    .nats-form-row select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }
    .nats-form-row input:focus,
    .nats-form-row select:focus {
      border-color: #2FAF9C;
      box-shadow: 0 0 0 3px rgba(47, 175, 156, 0.15);
      outline: none;
    }
    .nats-hint {
      font-size: 11px;
      color: #6c757d;
      margin-top: 4px;
      line-height: 1.4;
    }

    .nats-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    
    .nats-checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #2FAF9C;
      cursor: pointer;
    }
    
    .nats-checkbox-row label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
    }
    
    .nats-checkbox-row label i {
      margin-right: 8px;
      color: #2FAF9C;
    }
    .nats-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .nats-badge-dynamic {
      background: #d4edda;
      color: #155724;
    }
    .nats-badge-required {
      background: #f8d7da;
      color: #721c24;
    }
  </style>

  <div class="nats-subscribe-config">
    
    <!-- Basic Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-cog"></i>
          <span>Basic Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-tag"></i>Name</label>
          <input type="text" id="node-input-name" placeholder="Optional display name">
        </div>
        
        <div class="nats-form-row">
          <label><i class="fa fa-server"></i>NATS Server</label>
          <input type="text" id="node-input-server">
        </div>
       <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-debug">
          <label for="node-input-debug"><i class="fa fa-bug"></i>Enable Debug Logging</label>
        </div>
      </div>
    </div>
    
    <!-- Subscription Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-rss"></i>
          <span>Subscription Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-exchange"></i>Subscription Mode</label>
          <select id="node-input-subscriptionMode">
            <option value="static">Static (configured subject)</option>
            <option value="dynamic">Dynamic (via msg.topic/msg.subject)</option>
          </select>
          <div class="nats-hint">
            Static: Uses configured subject | Dynamic: Can be changed via input messages
          </div>
        </div>
        
        <div class="nats-form-row" id="nats-subject-row">
          <label><i class="fa fa-envelope"></i>NATS Subject <span class="nats-badge nats-badge-required">required</span></label>
          <input type="text" id="node-input-datapointid" placeholder="e.g. sensor.temperature or events.>">
          <div class="nats-hint">
            Wildcards: <code>*</code> (single level), <code>&gt;</code> (multi-level)
          </div>
        </div>
      </div>
    </div>
    
    <!-- Output Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-sign-out"></i>
          <span>Output Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-file-code-o"></i>Parse As</label>
          <select id="node-input-dataformat">
            <option value="auto">Auto-Detect (JSON or String)</option>
            <option value="json">JSON (force parsing)</option>
            <option value="string">String (no parsing)</option>
            <option value="buffer">Buffer (binary)</option>
          </select>
          <div class="nats-hint">
            Auto: Try JSON first, fallback to string | Buffer: For binary data
          </div>
        </div>
        
        <div class="nats-form-row">
          <label><i class="fa fa-tag"></i>Topic Field <span class="nats-badge nats-badge-dynamic">msg.topic</span></label>
          <select id="node-input-topicfield">
            <option value="subject">NATS Subject</option>
            <option value="id">Datapoint ID</option>
            <option value="name">Datapoint Name</option>
            <option value="datatype">Data Type</option>
          </select>
          <div class="nats-hint">
            Select what value to use for <code>msg.topic</code> in output messages
          </div>
        </div>
      </div>
    </div>
    
  </div>
</script>

<script type="text/x-red" data-help-name="nats-suite-subscribe">
  <p>Subscribes to messages from NATS subjects.</p>

  <h3>Subscription Modes</h3>
  <ul>
    <li><strong>Static:</strong> Uses the configured subject. Input messages are ignored.</li>
    <li><strong>Dynamic:</strong> Subject can be changed via <code>msg.topic</code> or <code>msg.subject</code></li>
  </ul>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">any</span></dt>
    <dd>The received message data (parsed based on format setting)</dd>
    
    <dt>topic <span class="property-type">string</span></dt>
    <dd>The topic field value based on configuration</dd>
    
    <dt class="optional">_reply <span class="property-type">string</span></dt>
    <dd>Reply subject for request-reply patterns</dd>
    
    <dt class="optional">headers <span class="property-type">object</span></dt>
    <dd>NATS message headers (if present)</dd>
  </dl>

  <h3>Dynamic Subscription</h3>
  <pre>// Change subscription via input message:
msg.topic = "sensor.temperature"
// or
msg.subject = "sensor.humidity"

// With queue group for load balancing:
msg.queueGroup = "workers"</pre>

  <h3>Subject Wildcards</h3>
  <ul>
    <li><code>*</code> - matches a single token (e.g., <code>sensor.*.temperature</code>)</li>
    <li><code>&gt;</code> - matches one or more tokens (e.g., <code>sensor.&gt;</code>)</li>
  </ul>
</script>
