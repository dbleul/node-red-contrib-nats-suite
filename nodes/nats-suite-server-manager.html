<script type="text/javascript">
  RED.nodes.registerType('nats-suite-server-manager', {
    category: 'NATS Suite',
    color: '#2FAF9C',
    defaults: {
      name: { value: "" },
      serverType: { value: "embedded", required: true },
      port: { value: 4222, required: true, validate: function(val) { return /^\d+$/.test(val) && parseInt(val) > 0 && parseInt(val) < 65536; } },
      leafPort: { value: 7422, required: true, validate: function(val) { return /^\d+$/.test(val) && parseInt(val) > 0 && parseInt(val) < 65536; } },
      enableJetStream: { value: false },
      storeDir: { value: "" },
      leafRemoteUrl: { value: "" },
      leafRemoteUser: { value: "" },
      leafRemotePass: { value: "" },
      autoStart: { value: true },
      debug: { value: false }
    },
    inputs: 1,
    outputs: 1,
    icon: "nats-icon-white.png",
    align: "left",
    label: function() {
      return this.name || "nats server manager";
    },
    paletteLabel: 'nats server manager',
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function() {
      // Show/hide fields based on server type
      const serverTypeField = $('#node-input-serverType');
      const portField = $('#node-input-port').closest('.form-row');
      const leafPortField = $('#node-input-leafPort').closest('.form-row');
      const leafRemoteField = $('#node-input-leafRemoteUrl').closest('.form-row');
      const leafUserField = $('#node-input-leafRemoteUser').closest('.form-row');
      const leafPassField = $('#node-input-leafRemotePass').closest('.form-row');
      const storeDirField = $('#node-input-storeDir').closest('.form-row');

      function updateVisibility() {
        const type = serverTypeField.val();
        portField.toggle(type !== 'leaf');
        leafPortField.toggle(type === 'leaf');
        leafRemoteField.toggle(type === 'leaf');
        leafUserField.toggle(type === 'leaf');
        leafPassField.toggle(type === 'leaf');
        storeDirField.toggle($('#node-input-enableJetStream').is(':checked'));
      }

      serverTypeField.on('change', updateVisibility);
      $('#node-input-enableJetStream').on('change', updateVisibility);
      updateVisibility();
    }
  });
</script>

<script type="text/html" data-template-name="nats-suite-server-manager">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  
  <div class="form-row">
    <label for="node-input-serverType"><i class="fa fa-server"></i> Server Type</label>
    <select id="node-input-serverType">
      <option value="embedded">Embedded (nats-memory-server)</option>
      <option value="nats-server">NATS server process</option>
      <option value="leaf">Leaf node server</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-port"><i class="fa fa-plug"></i> Port</label>
    <input type="number" id="node-input-port" placeholder="4222" min="1" max="65535">
  </div>

  <div class="form-row">
    <label for="node-input-leafPort"><i class="fa fa-plug"></i> Leaf Node Port</label>
    <input type="number" id="node-input-leafPort" placeholder="7422" min="1" max="65535">
  </div>

  <div class="form-row">
    <label for="node-input-leafRemoteUrl"><i class="fa fa-link"></i> Remote NATS Server URL</label>
    <input type="text" id="node-input-leafRemoteUrl" placeholder="nats://remote-server:4222">
  </div>

  <div class="form-row">
    <label for="node-input-leafRemoteUser"><i class="fa fa-user"></i> Remote username (optional)</label>
    <input type="text" id="node-input-leafRemoteUser" placeholder="Username">
  </div>

  <div class="form-row">
    <label for="node-input-leafRemotePass"><i class="fa fa-lock"></i> Remote password (optional)</label>
    <input type="password" id="node-input-leafRemotePass" placeholder="Password">
  </div>

  <div class="form-row">
    <label for="node-input-enableJetStream">
      <input type="checkbox" id="node-input-enableJetStream" style="display: inline-block; width: auto; vertical-align: top;">
      <span style="width: auto; display: inline-block; margin-left: 5px; vertical-align: top;">Enable JetStream</span>
    </label>
  </div>

  <div class="form-row">
    <label for="node-input-storeDir"><i class="fa fa-folder"></i> JetStream store directory (optional)</label>
    <input type="text" id="node-input-storeDir" placeholder="/tmp/nats-jetstream">
  </div>

  <div class="form-row">
    <label for="node-input-autoStart">
      <input type="checkbox" id="node-input-autoStart" style="display: inline-block; width: auto; vertical-align: top;" checked>
      <span style="width: auto; display: inline-block; margin-left: 5px; vertical-align: top;">Start automatically on deploy</span>
    </label>
  </div>

  <div class="form-row">
    <label for="node-input-debug">
      <input type="checkbox" id="node-input-debug" style="display: inline-block; width: auto; vertical-align: top;">
      <span style="width: auto; display: inline-block; margin-left: 5px; vertical-align: top;">Debug logging</span>
    </label>
  </div>
</script>

<script type="text/html" data-help-name="nats-suite-server-manager">
  <p>Starts and manages a NATS server directly from Node-RED.</p>

  <h3>Server types</h3>
  
  <h4>Embedded server (nats-memory-server)</h4>
  <p>Uses an in-memory NATS server for testing and development. Requires the <code>nats-memory-server</code> package.</p>
  <p><strong>Installation:</strong></p>
  <pre><code>npm install nats-memory-server</code></pre>

  <h4>NATS server process</h4>
  <p>Starts the official NATS server as a separate process. Requires <code>nats-server</code> to be available in the PATH.</p>
  <p><strong>Installation:</strong></p>
  <pre><code>// Linux/Mac
brew install nats-server
// or
go install github.com/nats-io/nats-server/v2@latest

// Windows
// Download from https://github.com/nats-io/nats-server/releases</code></pre>

  <h4>Leaf node server</h4>
  <p>Starts a leaf node server that connects to a remote NATS cluster.</p>

  <h3>Input</h3>
  <p>Control the server with messages:</p>
  <ul>
    <li><code>msg.payload.command = "start"</code> - start server</li>
    <li><code>msg.payload.command = "stop"</code> - stop server</li>
    <li><code>msg.payload.command = "restart"</code> - restart server</li>
    <li><code>msg.payload.command = "status"</code> - query status</li>
    <li><code>msg.payload.command = "toggle"</code> - toggle start/stop (default)</li>
  </ul>

  <h3>Output</h3>
  <p>Sends status events:</p>
  <ul>
    <li><code>msg.topic = "server.started"</code> - server was started</li>
    <li><code>msg.topic = "server.stopped"</code> - server was stopped</li>
    <li><code>msg.topic = "server.status"</code> - status information</li>
  </ul>
  <p><code>msg.payload</code> contains details such as port, URL, PID, etc.</p>

  <h3>Usage</h3>
  <p>After starting the server you can connect with other NATS Suite nodes:</p>
  <pre><code>nats://localhost:4222</code></pre>
  <p>For a leaf node server:</p>
  <pre><code>nats://localhost:7422</code></pre>
</script>

